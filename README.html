<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!--
/*
 * Copyright (c)2007 Mark Logic Corporation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * The use of the Apache License does not indicate that this project is
 * affiliated with the Apache Software Foundation.
 */
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-15">
<title>Corb - Content-Reprocessing in Bulk</title>
</head>

<body>
<h1>Corb - Content-Reprocessing in Bulk</h1>

<p>
Corb is a Java tool designed for bulk content-reprocessing.
Essentially, it lists all the documents in a collection
(or all the documents in the database),
and then uses a pool of worker threads
to apply an XQuery module to each document.
</p>

<h2>Required JVM: Sun 1.5 or later</h2>

<h2>Required libraries:</h2>
<ul>
  <li>Corb <a href="../releases/corb.jar">corb.jar</a></li>
  <li>MarkLogic <a href="http://developer.marklogic.com/">XCC</a></li>
</ul>

<h2>Required configuration:</h2>
<ul>
  <li>MarkLogic 3.2-1 or later</li>
  <li>The target database must be configured with a URI lexicon</li>
</ul>

<h2>Additional configuration notes</h2>
<p>If the target XDBC server is configured with a library location
on the filesystem:
<ul>
  <li>Both content processing and uri selection modules
  must be installed manually.
  </li>
  <li>The MODULE-ROOT parameter must be set to match
  the root-relative path to the installed modules
  (e.g. if the root is <code>/opt/MarkLogic/myapp/src/</code>
  and the modules are installed in
  <code>/opt/MarkLogic/myapp/src/reprocessing</code>,
  then the MODULE-ROOT should be set to <code>/reprocessing/</code>.</li>
</ul>
</p>
<p>If the target XDBC server is configured
with a library location pointing to a database:
<ul>
  <li>If the XDBC database is not the 'Modules' database (default),
  set Corb MODULES-DATABASE configuration to match.</li>
  <li>Unless specified using the MODULE-ROOT parameter,
  modules will be installed with a root derived from the package name.</li>
</ul>
</p>

<h2>Running Corb</h2>
<p>The entry point is the main method in the
 com.marklogic.developer.corb.Manager class.
Corb requires 3 command-line arguments:
<ul>
  <li>XCC-CONNECTION-URI</li>
  <li>COLLECTION-NAME</li>
  <li>XQUERY-MODULE
  (provide filesystem path if not contained in the corb package)</li>
</ul>
There are 5 additional optional command-line arguments:
<ul>
  <li>THREAD-COUNT (number of worker threads; default = 1)</li>
  <li>URIS-MODULE
  (alternate URI selection module, replacing provided Corb default).</li>
  <li>MODULE-ROOT (assumes '/' if not provided)</li>
  <li>MODULES-DATABASE
  (uses the XCC-CONNECTION-URI if not provided; use 0 for filesystem)</li>
  <li>INSTALL
  (default is true; set to 'false' or '0' to skip installation)</li>
</ul>
</p>

<pre>
com.marklogic.developer.corb.Manager \
  XCC-CONNECTION-URI COLLECTION-NAME XQUERY-MODULE [ THREAD-COUNT [ URIS-MODULE [ MODULE-ROOT [ MODULES-DATABASE [ INSTALL ] ] ] ] ]
</pre>

<h2>Writing a Custom URI Module</h2>

<p>The <code>URIS-MODULE</code> must be an XQuery main module,
and must return a sequence of <code>(xs:integer, xs:string*)</code>.
The first item must be the size of the subsequence sequence of URIs.
</p>

<p>For example, this simple <code>URIS-MODULE</code>
would return all available URIs from the URI Lexicon,
behaving just as Corb normally would with <code>COLLECTION-NAME=""</code>
and no <code>URIS-MODULE</code>.
</p>

<pre>
(: simple URIS-MODULE example :)
let $uris := cts:uris('', 'document')
return (count($uris), $uris)
</pre>

<p>This example may be extended to intersect a <code>cts:query</code>, etc.
</p>

<h2>Sample Invocations</h2>

<p>The following sample invocation
uses a sample medline-reprocessing XQuery module,
which is included in <code>corb.jar</code>.
</p>

<pre>
java -cp $HOME/lib/java/xcc.jar:$HOME/lib/java/corb.jar \
  com.marklogic.developer.corb.Manager \
  xcc://admin:admin@localhost:9002/ "" \
  medline-iso8601.xqy
</pre>

<p>Another sample invocation,
using a processing module loaded from the filesystem, an
alternate URI selection module, and 2 threads.
</p>

<pre>
java -cp $HOME/lib/java/xcc.jar:$HOME/lib/java/corb.jar \
  com.marklogic.developer.corb.Manager \
  xcc://admin:admin@localhost:9002/ "" \
  /home/myproject/src/custom-transform.xqy 2 \
  /home/myproject/src/custom-uri-selection.xqy
</pre>

<p>A third sample invocation. Using 4 threads, custom modules
pre-installed in the 'mydb' database
processing with /preprocessing/custom-transform.xqy and
using URIs returned by /preprocessing/custom-uri-selection.xqy:
</p>
<pre>
java -cp $HOME/lib/java/xcc.jar:$HOME/lib/java/corb.jar \
  com.marklogic.developer.corb.Manager \
  xcc://admin:admin@localhost:9002/ "" \
  custom-transform.xqy 4 \
  custom-uri-selection.xqy \
  /preprocessing/ \
  mydb
  false
</pre>

<p>
As Corb processes the documents, various progress messages will be logged.
</p>

</body>
</html>
